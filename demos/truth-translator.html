<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="https://upload.wikimedia.org/wikipedia/commons/4/47/React.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‰∫íËÅîÁΩëÂò¥Êõø | ÁúüËØùÁøªËØëÊú∫</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',
            secondary: '#ec4899',
            accent: '#8b5cf6',
            dark: '#1e293b',
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out',
            'slide-up': 'slideUp 0.5s ease-out',
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'mesh-flow': 'meshFlow 20s ease-in-out infinite alternate',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
            meshFlow: {
              '0%': { backgroundPosition: '0% 0%' },
              '100%': { backgroundPosition: '100% 100%' },
            }
          }
        },
      },
    }
  </script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    
    /* Animated Mesh Gradient Background */
    .mesh-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -1;
      background-color: #f8fafc;
      background-image: 
        radial-gradient(at 0% 0%, #E6F4FF 0px, transparent 50%),
        radial-gradient(at 100% 0%, #ECE9FF 0px, transparent 50%),
        radial-gradient(at 100% 100%, #E6F4FF 0px, transparent 50%),
        radial-gradient(at 0% 100%, #ECE9FF 0px, transparent 50%),
        radial-gradient(at 50% 50%, #fff 0px, transparent 50%);
      background-size: 180% 180%;
      animation: meshFlow 20s ease-in-out infinite alternate;
    }

    /* Custom scrollbar for textareas */
    textarea::-webkit-scrollbar {
      width: 8px;
    }
    textarea::-webkit-scrollbar-track {
      background: transparent; 
    }
    textarea::-webkit-scrollbar-thumb {
      background: #cbd5e1; 
      border-radius: 4px;
    }
    textarea::-webkit-scrollbar-thumb:hover {
      background: #94a3b8; 
    }

    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div class="mesh-background"></div>
  <div id="root"></div>

  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.2.0",
      "react-dom": "https://esm.sh/react-dom@18.2.0",
      "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
      "lucide-react": "https://esm.sh/lucide-react@0.294.0",
      "@google/genai": "https://esm.sh/@anthropic-ai/sdk@0.20.0?bundle=false&target=es2022"
    }
  }
  </script>

  <script type="module">
    import React, { useState, useEffect, useRef, createElement as h } from 'react';
    import { createRoot } from 'react-dom/client';
    import { 
      Sparkles, ArrowRight, AlertCircle, AlertTriangle, History, 
      Briefcase, HeartHandshake, Zap, Copy, Check, Share2,
      X, Trash2, Clock, ChevronRight, Download, Key, Settings
    } from 'lucide-react';

    // ==================== Types ====================
    const TranslationMode = {
      PROFESSIONAL: 'professional',
      HIGH_EQ: 'high_eq',
      SARCASTIC: 'sarcastic',
    };

    // ==================== API Key Storage ====================
    const API_KEY_STORAGE_KEY = 'gemini_api_key';
    
    const getStoredApiKey = () => {
      try {
        return localStorage.getItem(API_KEY_STORAGE_KEY) || '';
      } catch (e) {
        return '';
      }
    };

    const setStoredApiKey = (key) => {
      try {
        localStorage.setItem(API_KEY_STORAGE_KEY, key);
      } catch (e) {
        console.error('Failed to save API key', e);
      }
    };

    // ==================== Gemini Service ====================
    const SYSTEM_INSTRUCTION = `
You are the "Truth Translator" (ÁúüËØùÁøªËØëÊú∫), an expert in communication, psychology, and workplace politics. Your goal is to take the user's raw, emotional, straightforward, or even rude input (the "Inner Truth") and translate it into socially acceptable, strategic, or witty responses in Simplified Chinese.

**Modes Definitions:**
1.  **Professional (ËÅåÂú∫‰øùÂëΩ):** Formal, objective, polite, and defensive. Removes all emotion. Focuses on facts, policy, and "moving forward." Suitable for emails to bosses or clients.
2.  **High EQ / Soft (ÊâÄË∞ìÈ´òÊÉÖÂïÜ):** Gentle, seemingly empathetic, but firm. Uses the "sandwich method" (compliment-refusal-compliment). Can feel slightly manipulative or "green tea" style (innocent but deadly).
3.  **Sarcastic / Witty (Èò¥Èò≥ÊÄ™Ê∞î):** Intellectual roasting. No dirty words. Uses irony, rhetorical questions, and advanced vocabulary to mock the recipient politely.

**Constraints:**
- The output language must be **Simplified Chinese (ÁÆÄ‰Ωì‰∏≠Êñá)**.
- Do NOT lecture the user on morality. Your job is to translate, not judge.
- Ensure the "Sarcastic" mode does not use explicit profanity; it should be a "civilized insult".

**Output Format:**
Return a JSON object with the following structure:
{
  "analysis": "A short, 1-sentence analysis of the user's original emotion (in Chinese)",
  "translations": {
    "professional": "Professional mode translation",
    "high_eq": "High EQ mode translation", 
    "sarcastic": "Sarcastic mode translation"
  }
}
`;

    const translateText = async (inputText, apiKey) => {
      if (!apiKey) {
        throw new Error("ËØ∑ÂÖàËÆæÁΩÆ API Key");
      }

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          system_instruction: {
            parts: [{ text: SYSTEM_INSTRUCTION }]
          },
          contents: [{
            parts: [{ text: inputText }]
          }],
          generationConfig: {
            responseMimeType: "application/json",
          }
        })
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error?.message || 'API ËØ∑Ê±ÇÂ§±Ë¥•');
      }

      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
      
      if (!text) {
        throw new Error("No response from Gemini");
      }

      return JSON.parse(text);
    };

    // ==================== API Key Modal Component ====================
    const ApiKeyModal = ({ isOpen, onClose, onSave, initialKey, isInitialSetup }) => {
      const [apiKey, setApiKey] = useState(initialKey || '');
      const [showKey, setShowKey] = useState(false);

      useEffect(() => {
        setApiKey(initialKey || '');
      }, [initialKey, isOpen]);

      if (!isOpen) return null;

      const handleSave = () => {
        if (apiKey.trim()) {
          onSave(apiKey.trim());
          onClose();
        }
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter') {
          handleSave();
        }
      };

      return h('div', { 
        className: "fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in"
      },
        h('div', { 
          className: "relative bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden"
        },
          // Header
          h('div', { 
            className: "flex justify-between items-center p-5 border-b border-gray-100 bg-gradient-to-r from-indigo-500 to-purple-500"
          },
            h('h3', { 
              className: "font-bold text-white flex items-center gap-2"
            },
              h(Key, { className: "w-5 h-5" }),
              isInitialSetup ? "ËÆæÁΩÆ Gemini API Key" : "ÁÆ°ÁêÜ API Key"
            ),
            !isInitialSetup && h('button', { 
              onClick: onClose,
              className: "p-1 hover:bg-white/20 rounded-full transition-colors text-white"
            },
              h(X, { className: "w-5 h-5" })
            )
          ),
          // Content
          h('div', { className: "p-6" },
            h('p', { className: "text-slate-600 text-sm mb-4" },
              "ËØ∑ËæìÂÖ•‰Ω†ÁöÑ Gemini API Key„ÄÇ‰Ω†ÂèØ‰ª•Âú® ",
              h('a', { 
                href: "https://aistudio.google.com/app/apikey",
                target: "_blank",
                rel: "noopener noreferrer",
                className: "text-indigo-600 hover:underline"
              }, "Google AI Studio"),
              " Ëé∑ÂèñÂÖçË¥πÁöÑ API Key„ÄÇ"
            ),
            h('div', { className: "relative" },
              h('input', {
                type: showKey ? "text" : "password",
                value: apiKey,
                onChange: (e) => setApiKey(e.target.value),
                onKeyDown: handleKeyDown,
                placeholder: "AIzaSy...",
                className: "w-full p-4 pr-12 bg-slate-50 rounded-xl border border-slate-200 transition-all duration-300 text-slate-800 placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:bg-white focus:shadow-[0_0_15px_rgba(99,102,241,0.15)]"
              }),
              h('button', {
                onClick: () => setShowKey(!showKey),
                className: "absolute right-3 top-1/2 -translate-y-1/2 p-2 text-slate-400 hover:text-slate-600 transition-colors"
              },
                showKey ? "üôà" : "üëÅÔ∏è"
              )
            ),
            h('p', { className: "text-xs text-slate-400 mt-2" },
              "üîí API Key ‰ªÖ‰øùÂ≠òÂú®‰Ω†ÁöÑÊµèËßàÂô®Êú¨Âú∞Ôºå‰∏ç‰ºö‰∏ä‰º†Âà∞‰ªª‰ΩïÊúçÂä°Âô®„ÄÇ"
            )
          ),
          // Actions
          h('div', { className: "p-4 bg-slate-50 border-t border-gray-100 flex justify-end gap-3" },
            !isInitialSetup && h('button', {
              onClick: onClose,
              className: "px-4 py-2 text-slate-600 font-medium hover:bg-slate-100 rounded-lg transition-colors"
            }, "ÂèñÊ∂à"),
            h('button', {
              onClick: handleSave,
              disabled: !apiKey.trim(),
              className: `px-6 py-2 font-medium rounded-lg transition-all ${
                apiKey.trim() 
                  ? 'bg-indigo-600 text-white hover:bg-indigo-700 hover:scale-105 active:scale-95' 
                  : 'bg-slate-300 text-slate-500 cursor-not-allowed'
              }`
            }, "‰øùÂ≠ò")
          )
        )
      );
    };

    // ==================== Translation Card Component ====================
    const cardConfig = {
      [TranslationMode.PROFESSIONAL]: {
        title: 'üõ°Ô∏è ËÅåÂú∫Èò≤ÈîÖ',
        colorClass: 'bg-blue-50 border-blue-200 text-blue-900',
        iconClass: 'text-blue-600',
        btnClass: 'hover:bg-blue-100 text-blue-600',
        hoverClass: 'hover:shadow-blue-200/60 hover:border-blue-300',
        gradient: 'from-blue-500 to-cyan-400',
      },
      [TranslationMode.HIGH_EQ]: {
        title: 'üçµ È°∂Á∫ßÁªøËå∂',
        colorClass: 'bg-pink-50 border-pink-200 text-pink-900',
        iconClass: 'text-pink-600',
        btnClass: 'hover:bg-pink-100 text-pink-600',
        hoverClass: 'hover:shadow-pink-200/60 hover:border-pink-300',
        gradient: 'from-pink-500 to-rose-400',
      },
      [TranslationMode.SARCASTIC]: {
        title: 'üåö Èò¥Èò≥Â§ßÂ∏à',
        colorClass: 'bg-violet-50/80 border-violet-300 text-slate-800 shadow-sm',
        iconClass: 'text-violet-700',
        btnClass: 'hover:bg-violet-200 text-violet-700',
        hoverClass: 'hover:shadow-violet-200/60 hover:border-violet-400',
        gradient: 'from-violet-600 to-purple-500',
      },
    };

    const TranslationCard = ({ mode, content, delay, onShare }) => {
      const [copied, setCopied] = useState(false);
      const config = cardConfig[mode];
      const IconComponent = mode === TranslationMode.PROFESSIONAL ? Briefcase : 
                           mode === TranslationMode.HIGH_EQ ? HeartHandshake : Zap;

      const handleCopy = () => {
        navigator.clipboard.writeText(content);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      };

      return h('div', {
        className: `relative p-8 rounded-xl border-2 transition-all duration-300 ease-out transform hover:-translate-y-1 hover:shadow-xl ${config.colorClass} ${config.hoverClass} animate-slide-up flex flex-col`,
        style: { animationDelay: `${delay}ms` }
      },
        h('div', { className: "flex justify-between items-center mb-6" },
          h('div', { className: `flex items-center gap-2 font-bold text-lg ${config.iconClass}` },
            h(IconComponent, { className: "w-5 h-5" }),
            h('h3', null, config.title)
          ),
          h('div', { className: "flex items-center gap-1" },
            h('button', {
              onClick: () => onShare(mode, content),
              className: `p-2 rounded-full transition-colors ${config.btnClass}`,
              title: "ÁîüÊàêÂàÜ‰∫´ÂõæÁâá"
            },
              h(Share2, { className: "w-5 h-5" })
            ),
            h('div', { className: "relative" },
              copied && h('div', {
                className: "absolute bottom-full mb-2 left-1/2 transform -translate-x-1/2 w-max px-2 py-1 bg-gray-800 text-white text-xs rounded shadow-lg animate-fade-in z-10"
              }, "‚ú® ÊñáÊ°àÂ∑≤Â§çÂà∂ÔºåÂø´ÂéªÂèëÊå•ÂêßÔºÅ"),
              h('button', {
                onClick: handleCopy,
                className: `p-2 rounded-full transition-colors ${config.btnClass}`,
                title: "Â§çÂà∂ÊñáÊ°à"
              },
                h(copied ? Check : Copy, { className: "w-5 h-5" })
              )
            )
          )
        ),
        h('p', { 
          className: "text-base leading-relaxed whitespace-pre-wrap font-medium opacity-90"
        }, content)
      );
    };

    // ==================== Share Modal Component ====================
    const ShareModal = ({ isOpen, onClose, data }) => {
      const cardRef = useRef(null);
      const [isGenerating, setIsGenerating] = useState(false);

      if (!isOpen || !data) return null;

      const { mode, content } = data;
      const config = cardConfig[mode];
      const IconComponent = mode === TranslationMode.PROFESSIONAL ? Briefcase : 
                           mode === TranslationMode.HIGH_EQ ? HeartHandshake : Zap;

      const handleDownload = async () => {
        if (!cardRef.current) return;
        setIsGenerating(true);

        try {
          // Âä®ÊÄÅÂä†ËΩΩ html2canvas
          const html2canvas = (await import('https://esm.sh/html2canvas@1.4.1')).default;
          
          const canvas = await html2canvas(cardRef.current, {
            scale: 2,
            useCORS: true,
            backgroundColor: null,
          });

          const image = canvas.toDataURL('image/png');
          const link = document.createElement('a');
          link.href = image;
          link.download = `truth-translator-${mode}-${Date.now()}.png`;
          link.click();
        } catch (error) {
          console.error('Failed to generate image', error);
        } finally {
          setIsGenerating(false);
        }
      };

      return h('div', {
        className: "fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in"
      },
        h('div', {
          className: "relative bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden flex flex-col"
        },
          // Header
          h('div', { className: "flex justify-between items-center p-4 border-b border-gray-100" },
            h('h3', { className: "font-bold text-slate-700 flex items-center gap-2" },
              h(Sparkles, { className: "w-4 h-4 text-purple-500" }),
              "ÁîüÊàêÂàÜ‰∫´Âç°Áâá"
            ),
            h('button', {
              onClick: onClose,
              className: "p-1 hover:bg-slate-100 rounded-full transition-colors text-slate-500"
            },
              h(X, { className: "w-5 h-5" })
            )
          ),
          // Preview
          h('div', { className: "p-6 bg-slate-50 flex justify-center overflow-y-auto max-h-[60vh]" },
            h('div', {
              ref: cardRef,
              className: `w-full aspect-[4/5] max-w-[320px] rounded-xl shadow-lg flex flex-col relative overflow-hidden bg-gradient-to-br ${config.gradient}`
            },
              // Decorative elements
              h('div', { className: "absolute top-0 right-0 p-12 opacity-20 transform translate-x-1/3 -translate-y-1/3" },
                h('div', { className: "w-32 h-32 rounded-full bg-white blur-2xl" })
              ),
              h('div', { className: "absolute bottom-0 left-0 p-12 opacity-20 transform -translate-x-1/3 translate-y-1/3" },
                h('div', { className: "w-40 h-40 rounded-full bg-black blur-3xl" })
              ),
              // Card content
              h('div', { className: "flex-1 p-8 flex flex-col relative z-10" },
                h('div', { className: "flex items-center gap-3 mb-6" },
                  h('div', { className: "p-2 bg-white/20 backdrop-blur-md rounded-lg shadow-inner" },
                    h(IconComponent, { className: "w-6 h-6 text-white" })
                  ),
                  h('div', { className: "text-white" },
                    h('h2', { className: "text-xl font-bold tracking-wide" }, config.title),
                    h('p', { className: "text-xs opacity-80 uppercase tracking-widest" }, "Translation Mode")
                  )
                ),
                h('div', { className: "flex-1 flex items-center" },
                  h('div', { className: "bg-white/95 backdrop-blur-sm rounded-xl p-6 shadow-xl w-full" },
                    h('p', { className: "text-slate-800 text-lg leading-relaxed font-medium whitespace-pre-wrap relative" },
                      h('span', { className: "absolute -top-3 -left-2 text-4xl text-slate-200 font-serif" }, '"'),
                      content,
                      h('span', { className: "absolute -bottom-6 -right-2 text-4xl text-slate-200 font-serif leading-none" }, '"')
                    )
                  )
                ),
                h('div', { className: "mt-8 flex justify-between items-end" },
                  h('div', null,
                    h('p', { className: "text-white/60 text-xs" }, "Generated by"),
                    h('p', { className: "text-white font-bold text-sm" }, "‰∫íËÅîÁΩëÂò¥Êõø | ÁúüËØùÁøªËØëÊú∫")
                  ),
                  h('div', { className: "w-10 h-10 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center border border-white/30" },
                    h(Sparkles, { className: "w-5 h-5 text-white" })
                  )
                )
              )
            )
          ),
          // Actions
          h('div', { className: "p-4 bg-white border-t border-gray-100 flex justify-end gap-3" },
            h('button', {
              onClick: onClose,
              className: "px-4 py-2 text-slate-600 font-medium hover:bg-slate-50 rounded-lg transition-colors"
            }, "ÂèñÊ∂à"),
            h('button', {
              onClick: handleDownload,
              disabled: isGenerating,
              className: "flex items-center gap-2 px-6 py-2 bg-slate-900 text-white font-medium rounded-lg hover:bg-slate-800 transition-all hover:scale-105 active:scale-95 disabled:opacity-70 disabled:cursor-not-allowed"
            },
              isGenerating ? "ÁîüÊàê‰∏≠..." : [
                h(Download, { key: 'icon', className: "w-4 h-4" }),
                "‰øùÂ≠òÂõæÁâá"
              ]
            )
          )
        )
      );
    };

    // ==================== History Sidebar Component ====================
    const HistorySidebar = ({ isOpen, onClose, history, onSelect, onClear }) => {
      const formatDate = (timestamp) => {
        return new Intl.DateTimeFormat('zh-CN', {
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
        }).format(new Date(timestamp));
      };

      return h(React.Fragment, null,
        // Backdrop
        h('div', {
          className: `fixed inset-0 bg-black/20 backdrop-blur-sm z-40 transition-opacity duration-300 ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`,
          onClick: onClose
        }),
        // Sidebar
        h('div', {
          className: `fixed top-0 right-0 h-full w-full max-w-sm bg-white/95 backdrop-blur-md shadow-2xl z-50 transform transition-transform duration-300 ease-out flex flex-col ${isOpen ? 'translate-x-0' : 'translate-x-full'}`
        },
          // Header
          h('div', { className: "flex items-center justify-between p-5 border-b border-slate-100" },
            h('div', { className: "flex items-center gap-2 text-slate-800" },
              h(Clock, { className: "w-5 h-5 text-indigo-600" }),
              h('h2', { className: "text-lg font-bold" }, "ÂéÜÂè≤ËÆ∞ÂΩï"),
              h('span', { className: "text-xs font-medium text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full" }, history.length)
            ),
            h('button', {
              onClick: onClose,
              className: "p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-500"
            },
              h(X, { className: "w-5 h-5" })
            )
          ),
          // List
          h('div', { className: "flex-1 overflow-y-auto p-4 space-y-3" },
            history.length === 0 
              ? h('div', { className: "h-full flex flex-col items-center justify-center text-slate-400 gap-3" },
                  h(Clock, { className: "w-12 h-12 opacity-20" }),
                  h('p', null, "ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï")
                )
              : history.map((item) => 
                  h('div', {
                    key: item.id,
                    onClick: () => onSelect(item),
                    className: "group p-4 bg-white border border-slate-100 rounded-xl hover:border-indigo-300 hover:shadow-md transition-all cursor-pointer relative overflow-hidden"
                  },
                    h('div', { className: "absolute left-0 top-0 bottom-0 w-1 bg-indigo-500 opacity-0 group-hover:opacity-100 transition-opacity" }),
                    h('div', { className: "flex justify-between items-start mb-2" },
                      h('span', { className: "text-xs font-medium text-slate-400 flex items-center gap-1" },
                        formatDate(item.timestamp)
                      )
                    ),
                    h('p', { className: "text-sm text-slate-700 line-clamp-2 font-medium mb-2" }, item.inputText),
                    h('div', { className: "flex items-center gap-2 mt-2 pt-2 border-t border-slate-50" },
                      h('div', { className: "flex -space-x-2 overflow-hidden" },
                        h('div', { className: "inline-block h-5 w-5 rounded-full ring-2 ring-white bg-blue-100 flex items-center justify-center", title: "ËÅåÂú∫" }, "üõ°Ô∏è"),
                        h('div', { className: "inline-block h-5 w-5 rounded-full ring-2 ring-white bg-pink-100 flex items-center justify-center", title: "ÁªøËå∂" }, "üçµ"),
                        h('div', { className: "inline-block h-5 w-5 rounded-full ring-2 ring-white bg-violet-100 flex items-center justify-center", title: "Èò¥Èò≥" }, "üåö")
                      ),
                      h('span', { className: "text-xs text-indigo-600 group-hover:underline ml-auto flex items-center" },
                        "Êü•ÁúãËØ¶ÊÉÖ",
                        h(ChevronRight, { className: "w-3 h-3 ml-0.5" })
                      )
                    )
                  )
                )
          ),
          // Footer
          history.length > 0 && h('div', { className: "p-4 border-t border-slate-100 bg-slate-50" },
            h('button', {
              onClick: onClear,
              className: "w-full py-2.5 px-4 rounded-xl border border-red-200 text-red-600 hover:bg-red-50 hover:border-red-300 transition-colors flex items-center justify-center gap-2 text-sm font-medium"
            },
              h(Trash2, { className: "w-4 h-4" }),
              "Ê∏ÖÁ©∫ÂéÜÂè≤ËÆ∞ÂΩï"
            )
          )
        )
      );
    };

    // ==================== Main App Component ====================
    const App = () => {
      const [inputText, setInputText] = useState('');
      const [result, setResult] = useState(null);
      const [isLoading, setIsLoading] = useState(false);
      const [error, setError] = useState(null);
      
      // API Key state
      const [apiKey, setApiKey] = useState(getStoredApiKey());
      const [isApiKeyModalOpen, setIsApiKeyModalOpen] = useState(false);
      const [isInitialSetup, setIsInitialSetup] = useState(false);

      // Share Modal state
      const [isShareModalOpen, setIsShareModalOpen] = useState(false);
      const [shareData, setShareData] = useState(null);

      // History state
      const [history, setHistory] = useState([]);
      const [isHistoryOpen, setIsHistoryOpen] = useState(false);

      // Check for API key on mount
      useEffect(() => {
        const storedKey = getStoredApiKey();
        if (!storedKey) {
          setIsInitialSetup(true);
          setIsApiKeyModalOpen(true);
        } else {
          setApiKey(storedKey);
        }
      }, []);

      // Load history from local storage
      useEffect(() => {
        try {
          const savedHistory = localStorage.getItem('truth_translator_history');
          if (savedHistory) {
            setHistory(JSON.parse(savedHistory));
          }
        } catch (e) {
          console.error("Failed to load history", e);
        }
      }, []);

      const saveHistory = (newHistory) => {
        setHistory(newHistory);
        localStorage.setItem('truth_translator_history', JSON.stringify(newHistory));
      };

      const handleSaveApiKey = (key) => {
        setApiKey(key);
        setStoredApiKey(key);
        setIsInitialSetup(false);
      };

      const handleTranslate = async () => {
        if (!inputText.trim()) return;
        
        if (!apiKey) {
          setIsInitialSetup(true);
          setIsApiKeyModalOpen(true);
          return;
        }

        setIsLoading(true);
        setError(null);
        setResult(null);

        try {
          const data = await translateText(inputText, apiKey);
          setResult(data);

          // Add to history
          const newHistoryItem = {
            id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(),
            timestamp: Date.now(),
            inputText: inputText,
            result: data
          };
          
          const updatedHistory = [newHistoryItem, ...history].slice(0, 50);
          saveHistory(updatedHistory);
        } catch (err) {
          setError(err.message || "ÂàÜÊûêÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ");
          console.error(err);
        } finally {
          setIsLoading(false);
        }
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && e.metaKey) {
          handleTranslate();
        }
      };

      const handleShare = (mode, content) => {
        setShareData({ mode, content });
        setIsShareModalOpen(true);
      };

      const handleHistorySelect = (item) => {
        setInputText(item.inputText);
        setResult(item.result);
        setIsHistoryOpen(false);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };

      const handleClearHistory = () => {
        if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩïÂêóÔºü')) {
          saveHistory([]);
        }
      };

      return h('div', { className: "min-h-screen text-slate-800 font-sans selection:bg-indigo-100" },
        h('div', { className: "max-w-5xl mx-auto px-4 py-12 sm:px-6 lg:px-8 relative" },
          // Header Actions
          h('div', { className: "absolute top-6 right-6 sm:top-8 sm:right-8 z-20 flex items-center gap-2" },
            // API Key Button
            h('button', {
              onClick: () => {
                setIsInitialSetup(false);
                setIsApiKeyModalOpen(true);
              },
              className: `p-3 backdrop-blur-sm rounded-full shadow-sm border transition-all ${
                apiKey 
                  ? 'bg-white/80 border-slate-200 text-slate-600 hover:text-indigo-600 hover:shadow-md hover:scale-105'
                  : 'bg-amber-50 border-amber-300 text-amber-600 hover:bg-amber-100 hover:shadow-md hover:scale-105 animate-pulse'
              }`,
              title: apiKey ? "ÁÆ°ÁêÜ API Key" : "ËÆæÁΩÆ API Key"
            },
              h(Key, { className: "w-5 h-5" })
            ),
            // History Button
            h('button', {
              onClick: () => setIsHistoryOpen(true),
              className: "p-3 bg-white/80 backdrop-blur-sm rounded-full shadow-sm border border-slate-200 text-slate-600 hover:text-indigo-600 hover:shadow-md hover:scale-105 transition-all",
              title: "ÂéÜÂè≤ËÆ∞ÂΩï"
            },
              h(History, { className: "w-5 h-5" })
            )
          ),

          // Header
          h('div', { className: "text-center mb-12 animate-fade-in pt-8" },
            h('div', { className: "flex justify-center mb-4" },
              h('div', { className: "p-3 bg-indigo-600 rounded-2xl shadow-lg shadow-indigo-200" },
                h(Sparkles, { className: "w-8 h-8 text-white" })
              )
            ),
            h('h1', { className: "text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 tracking-tight mb-2" },
              "‰∫íËÅîÁΩëÂò¥Êõø | ÁúüËØùÁøªËØëÊú∫"
            ),
            h('h2', { className: "text-xl font-bold text-slate-400 mb-4 tracking-wide" },
              "Internet Mouthpiece"
            ),
            h('p', { className: "text-slate-500 max-w-lg mx-auto text-lg leading-relaxed" },
              "Êää‰Ω†ÁöÑÂ§ßÂÆûËØù„ÄÅÂøÉÈáåËØù„ÄÅÈöæÂê¨ËØùÔºåÂèòÊàêËÅåÂú∫Âæó‰Ωì„ÄÅÈ´òÊÉÖÂïÜÊàñÈò¥Èò≥ÊÄ™Ê∞îÁöÑÁ•ûÂõûÂ§ç„ÄÇ"
            )
          ),

          // Input Section
          h('div', { className: "bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl shadow-slate-200/50 p-6 sm:p-8 mb-10 border border-slate-100 animate-slide-up relative z-10" },
            h('div', { className: "relative" },
              h('label', { htmlFor: "input", className: "block text-sm font-semibold text-slate-700 mb-2" },
                "‰Ω†ÁöÑÂøÉÈáåËØù (Inner Truth)"
              ),
              h('div', { className: "relative" },
                h('textarea', {
                  id: "input",
                  className: "w-full h-40 p-4 bg-slate-50 rounded-xl border border-slate-200 transition-all duration-300 ease-in-out resize-none text-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:bg-white focus:shadow-[0_0_25px_rgba(99,102,241,0.2)]",
                  placeholder: "‰æãÂ¶ÇÔºöËøôÁ†¥‰ºöÂºÄÂæóÊ≤°ÂÆåÊ≤°‰∫ÜÔºåËÄÅÂ≠êÊÉ≥ÂõûÂÆ∂... (Example: This meeting is useless...)",
                  value: inputText,
                  onChange: (e) => setInputText(e.target.value),
                  onKeyDown: handleKeyDown
                }),
                h('div', { className: "absolute bottom-4 right-4 text-xs text-slate-400 pointer-events-none" },
                  "‚åò + Enter ÂèëÈÄÅ"
                )
              )
            ),
            h('div', { className: "mt-6 flex justify-end" },
              h('button', {
                onClick: handleTranslate,
                disabled: isLoading || !inputText.trim(),
                className: `group relative inline-flex items-center justify-center px-8 py-3 text-base font-medium text-white rounded-xl shadow-md transition-all duration-200 ${
                  isLoading || !inputText.trim()
                    ? 'bg-slate-300 cursor-not-allowed'
                    : 'bg-indigo-600 hover:bg-indigo-700 hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0'
                }`
              },
                isLoading
                  ? [
                      h('svg', { key: 'spinner', className: "animate-spin -ml-1 mr-3 h-5 w-5 text-white", xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24" },
                        h('circle', { className: "opacity-25", cx: "12", cy: "12", r: "10", stroke: "currentColor", strokeWidth: "4" }),
                        h('path', { className: "opacity-75", fill: "currentColor", d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" })
                      ),
                      "Ê≠£Âú®ÁøªËØë..."
                    ]
                  : [
                      "‰∏ÄÈîÆÁøªËØë ",
                      h(ArrowRight, { key: 'arrow', className: "ml-2 w-5 h-5 group-hover:translate-x-1 transition-transform" })
                    ]
              )
            ),
            error && h('div', { className: "mt-4 p-4 bg-red-50 border border-red-100 rounded-lg flex items-center text-red-600 animate-fade-in" },
              h(AlertCircle, { className: "w-5 h-5 mr-2 flex-shrink-0" }),
              error
            )
          ),

          // Results Section
          result && h('div', { className: "space-y-8 animate-fade-in relative z-10" },
            // Analysis Banner
            h('div', { className: "bg-yellow-50/90 backdrop-blur-sm border-l-4 border-yellow-400 p-4 rounded-r-lg shadow-sm flex items-start" },
              h(AlertTriangle, { className: "w-6 h-6 text-yellow-500 mr-3 flex-shrink-0 mt-0.5" }),
              h('div', null,
                h('h4', { className: "font-bold text-yellow-800 text-sm tracking-wide mb-1" }, "ÂΩìÂâçÊÉÖÁª™ËØäÊñ≠"),
                h('p', { className: "text-yellow-900 font-medium" }, result.analysis)
              )
            ),
            // Cards Grid
            h('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-6" },
              h(TranslationCard, {
                key: 'professional',
                mode: TranslationMode.PROFESSIONAL,
                content: result.translations.professional,
                delay: 100,
                onShare: handleShare
              }),
              h(TranslationCard, {
                key: 'high_eq',
                mode: TranslationMode.HIGH_EQ,
                content: result.translations.high_eq,
                delay: 200,
                onShare: handleShare
              }),
              h(TranslationCard, {
                key: 'sarcastic',
                mode: TranslationMode.SARCASTIC,
                content: result.translations.sarcastic,
                delay: 300,
                onShare: handleShare
              })
            )
          )
        ),

        // Modals
        h(ApiKeyModal, {
          isOpen: isApiKeyModalOpen,
          onClose: () => setIsApiKeyModalOpen(false),
          onSave: handleSaveApiKey,
          initialKey: apiKey,
          isInitialSetup: isInitialSetup
        }),
        h(ShareModal, {
          isOpen: isShareModalOpen,
          onClose: () => setIsShareModalOpen(false),
          data: shareData
        }),
        h(HistorySidebar, {
          isOpen: isHistoryOpen,
          onClose: () => setIsHistoryOpen(false),
          history: history,
          onSelect: handleHistorySelect,
          onClear: handleClearHistory
        })
      );
    };

    // ==================== Render App ====================
    const rootElement = document.getElementById('root');
    const root = createRoot(rootElement);
    root.render(h(React.StrictMode, null, h(App)));
  </script>
</body>
</html>

